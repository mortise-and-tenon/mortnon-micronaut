# 使用说明

## 编译指南

项目使用 Java 语言开发，使用 Maven 进行包管理，如果需要进行编译，环境需要安装有 JDK 11 和 Maven。

如果要将项目编译为 GraalVM 支持的 Native Image，JDK 需要使用 GraalVM，安装指南：https://www.graalvm.org/latest/docs/getting-started/linux/

如果要将项目编译为 Docker 镜像，环境还需要安装有 Docker，安装指南参考：https://docs.docker.com/engine/install/centos/

### 一、源码获取（通过 Git）

新建一个目录，进入目录，克隆仓库。命令如下：

- GitHub

```bash
git clone https://github.com/mortise-and-tenon/mortnon-micronaut.git
```

- Gitee

```bash
git clone https://gitee.com/mortise-and-tenon/mortnon-micronaut.git
```

---

**以下的制品制作没有依赖关系，自行选择最喜欢的方式**

### 二、制作 Jar

> 直接编译打包一个 Jar，就可以运行项目了。

#### Windows 环境

- 方法1：直接使用 IDEA 工具中的 Maven 选项 `package` 即可打包出 jar。
- 方法2：使用 CMD 或 PowerShell 切换到源码所在文件夹中编译，打包命令如下：

```bash
mvn clean -DskipTests package
```

#### Linux 环境

切换到源码所在的文件夹中，打包命令如下：

```bash
mvn clean -DskipTests package
```

打包成功后，在源码所在文件夹的 `target` 目录中看到编译成功的 jar: `mortnon-micronaut-X.X.jar`，大小约 55M，示例如下：

```bash
-rw-r--r-- 1 root root   1218435 Mar 26 10:17 mortnon-micronaut-0.1.jar
```

Jar 运行示例：

```bash
MICRONAUT_SERVER_PORT=8088 MYSQL_HOST=1.2.3.4 MYSQL_PORT=3307 MYSQL_USERNAME=root MYSQL_PASSWORD=mortnon_micronaut java -jar mortnon-micronaut-0.1.jar
```

### 三、制作为 Native Image（本地应用）

> Micronaut 框架支持 GraalVM 的 Native Image 编译，可以将 Java 应用编译为当前机器对应的本地应用，运行时性能更高、占用内存更小。

> 编译 Native Image 时，需要当前机器具有 8G 以上的内存，否则编译时容易因内存不够而失败。

执行以下命令，会将源码编译为适配当前机器的本地应用。

```bash
mvn package -Dpackaging=native-image
```

编译成功后，在源码所在文件夹中的 `target` 目录中看到编译成功的应用和库，示例如下：

```bash
-rw-r--r-- 1 root root     38488 Mar 26 10:23 libawt_headless.so
-rw-r--r-- 1 root root    899800 Mar 26 10:23 libawt.so
-rw-r--r-- 1 root root    473880 Mar 26 10:23 libawt_xawt.so
-rw-r--r-- 1 root root   2678152 Mar 26 10:23 libfontmanager.so
-rw-r--r-- 1 root root    239976 Mar 26 10:23 libjavajpeg.so
-rwxr-xr-x 1 root root      7704 Mar 26 10:23 libjava.so
-rwxr-xr-x 1 root root      7704 Mar 26 10:23 libjvm.so
-rw-r--r-- 1 root root    606056 Mar 26 10:23 liblcms.so
-rwxr-xr-x 1 root root 169699048 Mar 26 10:23 mortnon-micronaut
```

### 四、制作 Jar 的 Docker 镜像

> 如果需要将应用容器化，可以使用以下命令直接将 Jar 制作为 Docker 镜像。Micronaut 框架的 Maven 插件自带全套步骤，在编译时自动生成 Dockerfile，最终直接得到一个可运行的 Docker 镜像。

> 如果想自定义 Docker 镜像，需要自行编写 Dockerfile，并按[制作 Jar](#二制作-jar)打包得到 Jar 后自行处理后续镜像生成过程。 

```bash
mvn package -Dpackaging=docker
```

### 五、制作 Native Image 的 Docker 镜像

> 如果需要一个编译为本地应用的 Docker 镜像，可以按以下命令操作。

> 注意：编译的本地应用依赖当前所在的机器的 CPU 架构，如果需要国产化/信创的编译，需要使用相应的服务器并在编译参数中配置适用的 ARM 架构 Docker 基础镜像。

推荐基础镜像：
- redhat/ubi8-minimal:8.9 （93.2M）
- centos:centos7.9.2009 （204M）

> 由于项目有验证码图片生成功能，依赖了 Java 的 AWT 库，所以制作 Dokcer 镜像时，需要在 Docker 基础镜像中安装 freetype 库。

> 不论你使用哪个 Docker 镜像作为基础镜像，要注意镜像需要支持 Glibc，并且安装应用所需要的库（如 freetype 库）。 

- 基础镜像制作

`docker` 目录中给出了基于 ubi8-minimal 的安装 freetype 的 dockerfile 示例。可以用它生成我们需要基础镜像。

如下示例命令，将基于 `redhat/ubi8-minimal:8.9` 生成一个安装了 freetype 的基础镜像，镜像名为 `ubi8:freetype`。

```bash
docker build -f dockerfile-base -t ubi8:freetype .
```

- 制作镜像

以下命令，将编译源码，编译成功后将基于 `ubi8:freetype` 制作一个最终的制品镜像：

```bash
mvn package -Dpackaging=docker-native -Dmicronaut.native-image.base-image-run=ubi8:freetype
```
---

**注意**

如果编译时即发生报错，类似如下：

```bash
/usr/bin/ld: cannot find -lfreetype
```

说明当前机器上缺少 freetype，为当前机器安装上相应的包后再重新编译。

- CentOS

```bash
yum install freetype
```

- Ubuntu

```bash
apt-get install libfreetype6
```

---

- 运行镜像

```bash
docker run -e "MICRONAUT_SERVER_PORT=8088" -e "MYSQL_HOST=1.2.3.4" -e "MYSQL_PORT=3307" -e "MYSQL_USERNAME=root" -e "MYSQL_PASSWORD=mortnon_micronaut" -v /etc/localtime:/etc/localtime:ro -p 8088:8088 mortnon-micronaut:latest
```

### 六、自定义制作 Native Image 的 Docker 镜像

在[制作 Native Image 的 Docker 镜像](#五制作-native-image-的-docker-镜像)中，我们运行镜像后会发现日志输出的时区是GMT+0。原因是应用在镜像中启动时无法获取时区，即使将宿主机时区挂载到了容器中。

如果你需要严格确认日志中的时区显示，那就需要自定义制作镜像，整体流程与[制作 Native Image 的 Docker 镜像](#五制作-native-image-的-docker-镜像)一致，只是需要调整 Dockerfile，其他基础镜像制作、环境包安装本节不再涉及。

- 编译

```bash
mvn clean compile
```

- 生成原始 Dockerfile

```bash
mvn mn:dockerfile -Dpackaging=docker-native
```

- 复制启动脚本

将 `docker` 目录下的 `native_startup.sh` 复制到 `target` 目录下，示例：

```bash
chmod +x docker/native_startup.sh
cp docker/native_startup.sh ./target
```

- 调整 Dockerfile

修改 `target` 目录中的 Dockerfile 文件。

> 修复目的是将原有的入口 `/app/application` 变更为 `/native_startup.sh`，并将 Docker 镜像换为我们指定的镜像。
> 如果在项目 `pom.xml` 中使用 `<micronaut.native-image.base-img-run>` 配置了基础镜像，此处可不用修改基础镜像。

```bash
sed '/EXPOSE.*/i COPY native_startup.sh /native_startup.sh' ./target/Dockerfile > Dockerfile
sed -i 's#\"/app/application\"#\"/native_startup.sh"#g' Dockerfile
sed -i '/RUN apk update && apk add libstdc++/d' Dockerfile
sed -i 's/frolvlad\/alpine-glibc:alpine-3.12/ubi8:freetype/g' Dockerfile
```

最后调整后的 Dockerfile 文件内容示例如下：

```bash
FROM ghcr.io/graalvm/native-image:ol7-java11-22.3.2 AS builder
WORKDIR /home/app

COPY classes /home/app/classes
COPY dependency/* /home/app/libs/
ENV USE_NATIVE_IMAGE_JAVA_PLATFORM_MODULE_SYSTEM=false
RUN native-image -H:ReflectionConfigurationFiles=./classes/reflect-config.json -H:ResourceConfigurationFiles=./classes/resource-config.json -H:JNIConfigurationFiles=./classes/jni-config.json -H:Class=fun.mortnon.Application -H:Name=application --no-fallback -cp "/home/app/libs/*:/home/app/classes/"

FROM ubi8:freetype
COPY --from=builder /home/app/application /app/application

COPY native_startup.sh /native_startup.sh
EXPOSE 8080
ENTRYPOINT ["/native_startup.sh"]
```

- 制作 Docker 镜像

执行命令如下：

```bash
mvn package -Dpackaging=docker
```

- 运行镜像

```bash
docker run -e "MICRONAUT_SERVER_PORT=8088" -e "MYSQL_HOST=1.2.3.4" -e "MYSQL_PORT=3307" -e "MYSQL_USERNAME=root" -e "MYSQL_PASSWORD=mortnon_micronaut" -v /etc/localtime:/etc/localtime:ro -p 8088:8088 mortnon-micronaut:latest
```